<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin Panel | Study With Keshab</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root { --primary: #3498db; --secondary: #2ecc71; --danger: #e74c3c; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        
        /* ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .tab-btn { padding: 12px 25px; border: none; background: #eee; cursor: pointer; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ‡¶ï‡¶Æ‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        label { font-weight: bold; display: block; margin: 15px 0 5px; color: var(--dark); }
        input, select, button { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .btn { cursor: pointer; font-weight: bold; border: none; transition: 0.3s; color: white; }
        .btn-save { background: var(--secondary); margin-top: 20px; }
        .btn-delete { background: var(--danger); margin-top: 10px; }
        
        /* ‡¶ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶ü‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∞‡ßã ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .item-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .item-row input { flex: 1; }
        .btn-remove { width: 50px; background: var(--danger); }

        #editor { height: 400px; }
        .status { text-align: center; margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center;"><i class="fa-solid fa-user-shield"></i> ‡¶Æ‡¶æ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>

    <!-- ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶¨‡¶æ‡¶ü‡¶® -->
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('class-tab')">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü‡¶∞</button>
        <button class="tab-btn" onclick="openTab('settings-tab')">‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
    </div>

    <!-- ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡ßß: ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü -->
    <div id="class-tab" class="tab-content active">
        <label>‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
        <select id="existingClasses" onchange="loadSelectedClass()">
            <option value="">-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
        </select>
        <label>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶Ü‡¶á‡¶°‡¶ø (Unique ID):</label>
        <input type="text" id="docId" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: class1">
        <label>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡ßá‡¶∞ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ:</label>
        <input type="text" id="classTitle" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: Class 01: Formulas">
        <label>‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü:</label>
        <div id="editor"></div>
        <button class="btn btn-save" onclick="saveClassData()">üíæ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button id="deleteBtn" class="btn btn-delete" style="display:none;" onclick="deleteClassData()">üóëÔ∏è ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <!-- ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡ß®: ‡¶ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶ü‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ -->
    <div id="settings-tab" class="tab-content">
        <label>‡¶ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input type="text" id="chapterName">
        <label>‡¶∏‡¶æ‡¶¨‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤:</label>
        <input type="text" id="chapterSubtitle">

        <label>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø):</label>
        <div id="classListContainer"></div>
        <button class="btn" style="background:var(--primary); width:auto;" onclick="addRow('classListContainer')">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶∞‡ßã</button>

        <label>‡¶ï‡ßÅ‡¶á‡¶ú ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø):</label>
        <div id="quizListContainer"></div>
        <button class="btn" style="background:var(--primary); width:auto;" onclick="addRow('quizListContainer')">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßÅ‡¶á‡¶ú ‡¶∞‡ßã</button>

        <button class="btn btn-save" onclick="saveChapterSettings()">üöÄ ‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <div id="status" class="status"></div>
</div>

<!-- Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="js/firebase-config.js"></script>

<script>
    // ‡ßß. ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶∏‡ßÅ‡¶á‡¶ö‡¶ø‡¶Ç ‡¶≤‡¶ú‡¶ø‡¶ï
    function openTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // ‡ß®. ‡¶è‡¶°‡¶ø‡¶ü‡¶∞ ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
    var quill = new Quill('#editor', { theme: 'snow', modules: { toolbar: [['header'], ['bold', 'italic', 'underline'], [{'list': 'ordered'}, {'list': 'bullet'}], ['link', 'image'], ['clean']] } });
    const db = firebase.firestore();
    const chapterId = "Algebra";

    // --- ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ú‡¶ø‡¶ï ---
    function loadClassList() {
        const select = document.getElementById('existingClasses');
        select.innerHTML = '<option value="">-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';
        db.collection("class_notes").get().then(snap => {
            snap.forEach(doc => {
                let opt = document.createElement('option');
                opt.value = doc.id; opt.text = `${doc.data().title} (${doc.id})`;
                select.appendChild(opt);
            });
        });
    }

    function loadSelectedClass() {
        const id = document.getElementById('existingClasses').value;
        if(!id) { resetClassForm(); return; }
        document.getElementById('deleteBtn').style.display = "block";
        db.collection("class_notes").doc(id).get().then(doc => {
            if(doc.exists) {
                document.getElementById('docId').value = doc.id;
                document.getElementById('classTitle').value = doc.data().title;
                quill.root.innerHTML = doc.data().content;
            }
        });
    }

    function saveClassData() {
        const id = document.getElementById('docId').value;
        const title = document.getElementById('classTitle').value;
        const content = quill.root.innerHTML;
        if(!id || !title) return alert("ID and Title required");
        db.collection("class_notes").doc(id).set({ title, content, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge: true})
        .then(() => { alert("Saved!"); loadClassList(); });
    }

    function deleteClassData() {
        if(confirm("Delete this class?")) {
            db.collection("class_notes").doc(document.getElementById('docId').value).delete().then(() => { alert("Deleted"); resetClassForm(); loadClassList(); });
        }
    }

    function resetClassForm() {
        document.getElementById('docId').value = ""; document.getElementById('classTitle').value = "";
        quill.root.innerHTML = ""; document.getElementById('deleteBtn').style.display = "none";
    }

    // --- ‡¶ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶ü‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶≤‡¶ú‡¶ø‡¶ï ---
    function addRow(containerId, idVal = "", titleVal = "") {
        const container = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `
            <input type="text" placeholder="ID (‡¶Ø‡ßá‡¶Æ‡¶®: class1)" value="${idVal}" class="item-id">
            <input type="text" placeholder="Title" value="${titleVal}" class="item-title">
            <button class="btn btn-remove" onclick="this.parentElement.remove()">X</button>
        `;
        container.appendChild(div);
    }

    async function loadChapterSettings() {
        const doc = await db.collection("chapters").doc(chapterId).get();
        if(doc.exists) {
            const data = doc.data();
            document.getElementById('chapterName').value = data.name || "";
            document.getElementById('chapterSubtitle').value = data.subtitle || "";
            document.getElementById('classListContainer').innerHTML = "";
            document.getElementById('quizListContainer').innerHTML = "";
            if(data.classes) data.classes.forEach(c => addRow('classListContainer', c.id, c.title));
            if(data.quizzes) data.quizzes.forEach(q => addRow('quizListContainer', q.id, q.title));
        }
    }

    async function saveChapterSettings() {
        const name = document.getElementById('chapterName').value;
        const subtitle = document.getElementById('chapterSubtitle').value;
        const classes = [];
        document.querySelectorAll('#classListContainer .item-row').forEach(row => {
            const id = row.querySelector('.item-id').value;
            const title = row.querySelector('.item-title').value;
            if(id && title) classes.push({id, title});
        });
        const quizzes = [];
        document.querySelectorAll('#quizListContainer .item-row').forEach(row => {
            const id = row.querySelector('.item-id').value;
            const title = row.querySelector('.item-title').value;
            if(id && title) quizzes.push({id, title});
        });

        await db.collection("chapters").doc(chapterId).set({ name, subtitle, classes, quizzes, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        alert("Homepage Updated!");
    }

    // ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú
    firebase.auth().onAuthStateChanged(user => {
        if(user) { loadClassList(); loadChapterSettings(); }
        else { window.location.href = "../../../../login.html"; }
    });
</script>
</body>
</html>