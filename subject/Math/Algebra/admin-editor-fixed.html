<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Admin Panel | SWK</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <style>
        :root { --primary: #3498db; --secondary: #2ecc71; --danger: #e74c3c; --dark: #2c3e50; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        
        h2 { text-align: center; color: var(--dark); margin-bottom: 30px; font-weight: 700; }
        
        /* Tabs */
        .tabs { display: flex; background: #eee; padding: 5px; border-radius: 12px; margin-bottom: 30px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; cursor: pointer; border-radius: 10px; font-weight: 600; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); }

        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Form Elements */
        label { font-weight: 600; display: block; margin: 20px 0 8px; color: #555; }
        input, select { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; font-size: 15px; transition: 0.3s; outline: none; }
        input:focus { border-color: var(--primary); }
        
        .item-row { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; background: #fafafa; padding: 10px; border-radius: 10px; }
        .item-row input { flex: 1; border: 1px solid #ddd; }
        
        .btn { cursor: pointer; font-weight: bold; border: none; border-radius: 10px; transition: 0.3s; color: white; padding: 12px 20px; }
        .btn-save { background: var(--secondary); width: 100%; margin-top: 25px; font-size: 16px; }
        .btn-save:hover { background: #27ae60; transform: translateY(-2px); }
        .btn-add { background: var(--primary); font-size: 14px; margin-top: 10px; }
        .btn-remove { background: var(--danger); padding: 8px 15px; }

        #editor { height: 300px; border-radius: 0 0 10px 10px; }
        .status-msg { text-align: center; margin-top: 15px; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <h2><i class="fa-solid fa-user-shield"></i> ‡¶Æ‡¶æ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('class-tab', this)">‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü‡¶∞</button>
        <button class="tab-btn" onclick="openTab('settings-tab', this)">‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
    </div>

    <!-- Tab 1: Class Editor -->
    <div id="class-tab" class="tab-content active">
        <label>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
        <select id="existingClasses" onchange="loadSelectedClass()">
            <option value="">-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
        </select>
        <label>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶Ü‡¶á‡¶°‡¶ø (Unique ID):</label>
        <input type="text" id="docId" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: class1">
        <label>‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ:</label>
        <input type="text" id="classTitle" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶≤‡¶æ‡¶≠ ‡¶ì ‡¶ï‡ßç‡¶∑‡¶§‡¶ø - ‡¶™‡¶æ‡¶∞‡ßç‡¶ü ‡ßß">
        <label>‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü:</label>
        <div id="editor"></div>
        <button class="btn btn-save" onclick="saveClassData()">üíæ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <!-- Tab 2: Homepage Settings -->
    <div id="settings-tab" class="tab-content">
        <label>‡¶ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶ü‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
        <input type="text" id="chapterName" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: Profit and Loss">
        <label>‡¶∏‡¶æ‡¶¨‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤:</label>
        <input type="text" id="chapterSubtitle" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶∏‡¶ô‡ßç‡¶ó‡ßÄ">

        <label>CBT ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï (URL):</label>
        <input type="text" id="cbtLink" placeholder="https://exam-link.com">

        <label>‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø):</label>
        <div id="classListContainer"></div>
        <button class="btn btn-add" onclick="addRow('classListContainer')">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶∞‡ßã</button>

        <label>‡¶ï‡ßÅ‡¶á‡¶ú ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø):</label>
        <div id="quizListContainer"></div>
        <button class="btn btn-add" onclick="addRow('quizListContainer')">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßÅ‡¶á‡¶ú ‡¶∞‡ßã</button>

        <button class="btn btn-save" onclick="saveChapterSettings()">üöÄ ‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <div id="status" class="status-msg"></div>
</div>

<!-- Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
<script src="js/firebase-config.js"></script>

<script>
    const db = firebase.firestore();
    const chapterId = "Algebra"; // ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ index.html ‡¶è‡¶ì ‡¶è‡¶á ID ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
    var quill = new Quill('#editor', { theme: 'snow' });

    function openTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
    }

    function addRow(containerId, idVal = "", titleVal = "") {
        const container = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `
            <input type="text" placeholder="ID" value="${idVal}" class="item-id">
            <input type="text" placeholder="Title" value="${titleVal}" class="item-title">
            <button class="btn btn-remove" onclick="this.parentElement.remove()">X</button>
        `;
        container.appendChild(div);
    }

    // ‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (FIXED)
    async function saveChapterSettings() {
        const status = document.getElementById('status');
        status.innerText = "‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";

        const name = document.getElementById('chapterName').value;
        const subtitle = document.getElementById('chapterSubtitle').value;
        const cbtLink = document.getElementById('cbtLink').value;

        const classes = [];
        document.querySelectorAll('#classListContainer .item-row').forEach(row => {
            const id = row.querySelector('.item-id').value;
            const title = row.querySelector('.item-title').value;
            if(id && title) classes.push({id, title});
        });

        const quizzes = [];
        document.querySelectorAll('#quizListContainer .item-row').forEach(row => {
            const id = row.querySelector('.item-id').value;
            const title = row.querySelector('.item-title').value;
            if(id && title) quizzes.push({id, title});
        });

        try {
            await db.collection("chapters").doc(chapterId).set({
                name,
                subtitle,
                cbtLink,
                classes,
                quizzes,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            status.style.color = "green";
            status.innerText = "‚úÖ ‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!";
            alert("CBT ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶∏‡¶π ‡¶∏‡¶¨ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
        } catch (error) {
            console.error("Error updating document: ", error);
            status.style.color = "red";
            status.innerText = "‚ùå ‡¶è‡¶∞‡¶∞: " + error.message;
            alert("‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶ï‡¶®‡¶∏‡ßã‡¶≤ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        }
    }

    // ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    async function saveClassData() {
        const id = document.getElementById('docId').value;
        const title = document.getElementById('classTitle').value;
        const content = quill.root.innerHTML;
        
        if (!id || !title) return alert("ID ‡¶è‡¶¨‡¶Ç Title ‡¶¶‡¶ø‡¶®");
        
        try {
            await db.collection("class_notes").doc(id).set({
                title: title,
                content: content,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
            loadClassList();
        } catch (error) {
            alert("‡¶è‡¶∞‡¶∞: " + error.message);
        }
    }

    // ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶°
    function loadClassList() {
        const select = document.getElementById('existingClasses');
        select.innerHTML = '<option value="">-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶® --</option>';
        db.collection("class_notes").get().then(snap => {
            snap.forEach(doc => {
                const opt = document.createElement('option');
                opt.value = doc.id;
                opt.text = `${doc.data().title} (${doc.id})`;
                select.appendChild(opt);
            });
        });
    }

    // ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü
    function loadSelectedClass() {
        const id = document.getElementById('existingClasses').value;
        if (!id) {
            document.getElementById('docId').value = '';
            document.getElementById('classTitle').value = '';
            quill.root.innerHTML = '';
            return;
        }
        
        db.collection("class_notes").doc(id).get().then(doc => {
            if (doc.exists) {
                document.getElementById('docId').value = doc.id;
                document.getElementById('classTitle').value = doc.data().title;
                quill.root.innerHTML = doc.data().content;
            }
        });
    }

    // ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ü‡¶®‡¶æ
    async function loadInitialData() {
        const doc = await db.collection("chapters").doc(chapterId).get();
        if(doc.exists) {
            const data = doc.data();
            document.getElementById('chapterName').value = data.name || "";
            document.getElementById('chapterSubtitle').value = data.subtitle || "";
            document.getElementById('cbtLink').value = data.cbtLink || "";
            if(data.classes) data.classes.forEach(c => addRow('classListContainer', c.id, c.title));
            if(data.quizzes) data.quizzes.forEach(q => addRow('quizListContainer', q.id, q.title));
        }
        loadClassList();
    }

    firebase.auth().onAuthStateChanged(user => {
        if(user) { loadInitialData(); }
        else { window.location.href = "../../../../login.html"; }
    });
</script>
</body>
</html>