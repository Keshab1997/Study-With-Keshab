<!doctype html>
<html lang="bn">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
      id="viewportMeta"
    />
    <title>অ্যাকাউন্ট তৈরি করুন - Study With Keshab</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#4a90e2" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome for Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <link rel="stylesheet" href="css/login-style.css" />
  </head>
  <body class="login-page">
    <div class="animation-area">
      <ul class="box-area">
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </div>

    <div class="login-container">
      <div class="login-header">
        <a href="index.html">
          <img src="images/icons/icon-512x512.png" alt="Logo" class="logo" />
        </a>
        <h1>অ্যাকাউন্ট তৈরি করুন</h1>
        <p>নতুন শেখার যাত্রা শুরু করুন।</p>
      </div>

      <div class="login-form">
        <div class="input-group">
          <i class="fa-solid fa-user"></i>
          <input
            type="text"
            id="name-input"
            placeholder="আপনার পুরো নাম"
            required
          />
        </div>

        <div class="input-group">
          <i class="fa-solid fa-envelope"></i>
          <input
            type="email"
            id="email-input"
            placeholder="আপনার ইমেল"
            required
          />
        </div>

        <div class="input-group">
          <i class="fa-solid fa-lock"></i>
          <input
            type="password"
            id="password-input"
            placeholder="নতুন পাসওয়ার্ড (কমপক্ষে ৬ অক্ষর)"
            required
          />
        </div>

        <button id="signup-button" class="login-btn">
          <span class="btn-text">সাইন আপ করুন</span>
          <div class="spinner"></div>
        </button>

        <p id="error-message"></p>

        <div class="divider"><span>অথবা</span></div>

        <button id="google-signup-btn" class="google-btn">
          <i class="fab fa-google"></i>
          <span>Google দিয়ে সাইন আপ করুন</span>
        </button>
      </div>

      <div class="login-footer">
        <p>ইতিমধ্যেই অ্যাকাউন্ট আছে? <a href="login.html">লগইন করুন</a></p>
        <a href="index.html">হোম পেজে ফিরে যান</a>
      </div>
    </div>

    <!-- Audio Elements -->
    <audio id="click-sound" src="audio/click-sound.mp3" preload="auto"></audio>
    <audio id="error-sound" src="audio/error-sound.mp3" preload="auto"></audio>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="js/firebase-config.js"></script>

    <!-- Signup Logic Script -->
    <script>
      const signupButton = document.getElementById("signup-button");
      const nameInput = document.getElementById("name-input");
      const emailInput = document.getElementById("email-input");
      const passwordInput = document.getElementById("password-input");
      const errorMessage = document.getElementById("error-message");
      const clickSound = document.getElementById("click-sound");
      const errorSound = document.getElementById("error-sound");

      signupButton.addEventListener("click", () => {
        const name = nameInput.value.trim();
        const email = emailInput.value.trim();
        const password = passwordInput.value;

        function playErrorSound() {
          errorSound.currentTime = 0;
          errorSound.play();
        }

        if (!name || !email || !password) {
          errorMessage.textContent = "দয়া করে সব ঘর পূরণ করুন।";
          playErrorSound();
          return;
        }
        if (password.length < 6) {
          errorMessage.textContent = "পাসওয়ার্ডটি অন্তত ৬ অক্ষরের হতে হবে।";
          playErrorSound();
          return;
        }

        clickSound.currentTime = 0;
        clickSound.play();

        errorMessage.textContent = "";
        signupButton.classList.add("loading");

        firebase
          .auth()
          .createUserWithEmailAndPassword(email, password)
          .then((userCredential) => {
            const user = userCredential.user;
            return user.updateProfile({
              displayName: name
            }).then(() => {
              return firebase.firestore().collection("users").doc(user.uid).set({
                name: name,
                email: email,
                role: "student",
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
            });
          })
          .then(() => {
            alert("আপনার অ্যাকাউন্ট সফলভাবে তৈরি হয়েছে!");
            window.location.href = "index.html";
          })
          .catch((error) => {
            playErrorSound();
            if (error.code === "auth/email-already-in-use") {
              errorMessage.textContent = "এই ইমেল ঠিকানাটি ইতিমধ্যেই ব্যবহার করা হয়েছে।";
            } else if (error.code === "auth/invalid-email") {
              errorMessage.textContent = "দয়া করে একটি সঠিক ইমেল ঠিকানা দিন।";
            } else if (error.code === "auth/weak-password") {
              errorMessage.textContent = "পাসওয়ার্ডটি খুব দুর্বল। আরও শক্তিশালী পাসওয়ার্ড দিন।";
            } else {
              errorMessage.textContent = "একটি সমস্যা হয়েছে। দয়া করে আবার চেষ্টা করুন।";
            }
          })
          .finally(() => {
            signupButton.classList.remove("loading");
          });
      });

      // Google Signup
      const googleSignupBtn = document.getElementById("google-signup-btn");
      if (googleSignupBtn) {
        googleSignupBtn.addEventListener("click", () => {
          const auth = firebase.auth();
          const db = firebase.firestore();
          const provider = new firebase.auth.GoogleAuthProvider();
          const ADMIN_EMAIL = "keshabsarkar2018@gmail.com";

          auth.signInWithPopup(provider).then(result => {
            const user = result.user;
            const userRef = db.collection('users').doc(user.uid);

            return userRef.get().then(doc => {
              const userData = {
                uid: user.uid,
                displayName: user.displayName,
                email: user.email,
                photoURL: user.photoURL,
                lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
              };

              if (!doc.exists) {
                userData.role = (user.email === ADMIN_EMAIL) ? 'admin' : 'student';
                userData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
              }

              return userRef.set(userData, { merge: true });
            });
          }).then(() => {
            window.location.href = 'index.html';
          }).catch(error => {
            console.error("Google সাইন-আপ এর সময় সমস্যা:", error);
            errorMessage.textContent = "সাইন আপ করার সময় একটি সমস্যা হয়েছে।";
            playErrorSound();
          });
        });
      }
    </script>

    <!-- PWA এর জন্য Service Worker রেজিস্ট্রেশন -->
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("sw.js")
            .then((registration) => {
              console.log("ServiceWorker registration successful!");
            })
            .catch((err) => {
              console.log("ServiceWorker registration failed: ", err);
            });
        });
      }
    </script>
  </body>
</html>
